<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plank Panda 9.5</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Default Theme Variables */
            --bg: #E0F2F1;
            --bg-image: none; /* New: For gradients/scenery */
            --primary: #26A69A;
            --primary-dark: #00897B;
            --accent: #FF7043;
            --text: #37474F;
            --card: #FFFFFF;
            --danger: #ef5350;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background-color: var(--bg);
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: var(--text);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: manipulation;
            transition: background 0.5s ease, color 0.5s ease;
        }

        /* --- Header --- */
        header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo { font-weight: 700; color: var(--primary-dark); letter-spacing: 1px; font-size: 1.1rem; }

        .header-actions { display: flex; gap: 10px; }

        .header-btn {
            background: var(--card);
            border: none;
            color: var(--text);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }
        .header-btn:active { transform: scale(0.95); }
        .header-btn.muted { opacity: 0.5; background: #eceff1; }

        /* --- Main Stage (Panda) --- */
        .stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .brain-badge {
            background: var(--primary-dark);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .brain-badge.visible { opacity: 1; }
        .pulsing-dot {
            width: 6px; height: 6px; background: #00E676; border-radius: 50%;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .bubble {
            background: var(--card);
            color: var(--text);
            padding: 15px 25px;
            border-radius: 20px;
            margin-bottom: 40px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            font-size: 1.1rem;
            font-weight: 600;
            position: relative;
            transform: scale(0);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 85%;
            text-align: center;
            z-index: 20;
            min-height: 24px;
            pointer-events: none;
        }
        .bubble.visible { transform: scale(1); }
        .bubble::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 8px 8px 0;
            border-style: solid;
            border-color: var(--card) transparent;
        }

        /* --- THE PANDA ANIMATION --- */
        .panda-container {
            width: 200px;
            height: 160px;
            position: relative;
            transition: transform 0.5s ease;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .poked { animation: poke-anim 0.3s ease; }
        @keyframes poke-anim {
            0% { transform: scale(1); }
            40% { transform: scale(0.95) translateY(5px); }
            80% { transform: scale(1.05) translateY(-2px); }
            100% { transform: scale(1); }
        }

        .head {
            width: 70px; height: 60px; background: white; border-radius: 35px 35px 30px 30px;
            position: absolute; z-index: 10; border: 3px solid #333; transition: all 0.5s ease;
        }
        .ear {
            width: 22px; height: 22px; background: #333; border-radius: 50%;
            position: absolute; top: -5px; z-index: 5;
        }
        .ear.left { left: -5px; } .ear.right { right: -5px; }
        
        .eye {
            width: 18px; height: 14px; background: #333; border-radius: 50% 50% 40% 40%;
            position: absolute; top: 20px; transform: rotate(-10deg);
        }
        .eye.right { right: 12px; transform: rotate(10deg); } .eye.left { left: 12px; }
        
        .pupil {
            width: 4px; height: 4px; background: white; border-radius: 50%;
            position: absolute; top: 3px; left: 4px;
        }

        .nose {
            width: 12px; height: 8px; background: #333; border-radius: 10px;
            position: absolute; bottom: 18px; left: 50%; transform: translateX(-50%);
        }

        .body {
            background: white; border: 3px solid #333; position: absolute;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .leg {
            background: #333; border-radius: 20px; position: absolute;
            transition: all 0.5s ease;
        }

        /* Idle State */
        .idle .head { top: 10px; left: 65px; }
        .idle .body { width: 90px; height: 80px; border-radius: 40px 40px 50px 50px; top: 60px; left: 55px; z-index: 8; }
        .idle .leg.arm { width: 25px; height: 45px; top: 70px; z-index: 9; }
        .idle .leg.arm.left { left: 45px; transform: rotate(20deg); }
        .idle .leg.arm.right { right: 45px; transform: rotate(-20deg); }
        .idle .leg.foot { width: 30px; height: 20px; bottom: 20px; z-index: 7; }
        .idle .leg.foot.left { left: 60px; } .idle .leg.foot.right { right: 60px; }
        .idle .leg.extra { opacity: 0; top: 60px; }

        /* Plank State */
        .plank .head { top: 35px; left: 140px; transform: rotate(10deg); }
        .plank .body { width: 120px; height: 60px; border-radius: 30px; top: 45px; left: 30px; }
        .plank .leg.arm { width: 15px; height: 35px; top: 90px; z-index: 6; }
        .plank .leg.arm.left { left: 110px; }
        .plank .leg.arm.right { left: 125px; opacity: 0; }
        .plank .leg.foot { width: 15px; height: 35px; top: 90px; z-index: 6; }
        .plank .leg.foot.left { left: 40px; }
        .plank .leg.foot.right { left: 55px; opacity: 0; }
        .plank .leg.extra { width: 15px; height: 35px; background: #222; position: absolute; top: 85px; z-index: 5; transition: all 0.5s; }
        .plank .leg.extra.f { left: 125px; } .plank .leg.extra.b { left: 55px; }

        .shaking { animation: vibrate 0.15s infinite; }
        @keyframes vibrate {
            0% { transform: translate(0, 0) rotate(0); }
            25% { transform: translate(-1px, 1px) rotate(-0.5deg); }
            50% { transform: translate(-1px, -1px) rotate(0.5deg); }
            75% { transform: translate(1px, 1px) rotate(0); }
            100% { transform: translate(0, 0) rotate(0); }
        }

        /* Fixed Sweat: Higher z-index, absolute positioning adjustments */
        .sweat { 
            position: absolute; 
            font-size: 24px; 
            color: #4FC3F7; 
            opacity: 0; 
            top: 20px; 
            left: 170px; 
            z-index: 20; 
            pointer-events: none;
        }
        .sweat.active { animation: drop 0.8s infinite; }
        @keyframes drop {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(25px); }
        }

        /* --- Controls --- */
        .controls {
            background: var(--card);
            border-top-left-radius: 30px; border-top-right-radius: 30px;
            padding: 25px 25px 35px 25px;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.05); text-align: center;
        }

        .timer-display {
            font-size: 4.5rem; font-weight: 700; line-height: 1; color: var(--text);
            font-variant-numeric: tabular-nums; margin-bottom: 15px;
        }

        .daily-info {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; color: #78909C; font-size: 0.9rem; font-weight: 600;
        }

        .progress-bar {
            height: 18px; background: #ECEFF1; border-radius: 9px; overflow: hidden; margin-bottom: 20px;
        }
        
        .progress-fill {
            height: 100%; width: 0%; background: var(--primary);
            transition: width 0.3s ease, background-color 0.3s; border-radius: 9px;
        }

        .btn-main {
            width: 100%; padding: 20px; border: none; border-radius: 20px;
            background: var(--text); color: white; font-size: 1.4rem; font-weight: 700;
            font-family: inherit; cursor: pointer; box-shadow: 0 4px 0 #000; transition: all 0.1s;
        }
        .btn-main:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-main.active { background: var(--accent); box-shadow: 0 4px 0 #D84315; }
        .btn-main.active:active { transform: translateY(4px); box-shadow: none; }

        .btn-history {
            background: none; border: none; color: #90A4AE; font-size: 0.9rem;
            font-weight: 600; margin-top: 15px; cursor: pointer; padding: 10px; font-family: inherit;
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center;
            z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        
        .modal {
            background: var(--card); color: var(--text);
            padding: 25px; border-radius: 20px; width: 85%; max-width: 320px;
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transform: translateY(20px); transition: transform 0.2s;
            max-height: 80vh; overflow-y: auto;
        }
        .modal-overlay.open .modal { transform: translateY(0); }
        .modal h3 { margin: 0 0 15px 0; color: var(--text); }
        
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; font-size: 0.9rem; color: #78909C; margin-bottom: 5px; }
        .input-group input { 
            width: 100%; padding: 10px; border: 2px solid #ECEFF1; 
            border-radius: 10px; font-size: 1rem; box-sizing: border-box; font-family: inherit;
            background: var(--card); color: var(--text);
        }

        /* Theme Selector */
        .theme-selector {
            display: flex; gap: 10px; justify-content: space-between; margin-bottom: 20px;
        }
        .theme-btn {
            width: 40px; height: 40px; border-radius: 50%; border: 3px solid transparent; cursor: pointer;
            transition: transform 0.2s;
            position: relative; overflow: hidden; /* For gradient preview */
        }
        .theme-btn:active { transform: scale(0.9); }
        .theme-btn.selected { border-color: var(--text); transform: scale(1.1); }

        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        
        /* Updated Button Styles */
        .btn-modal { 
            flex: 1; width: 100%; padding: 16px; border: none; border-radius: 16px; 
            font-weight: 700; font-size: 1.1rem; cursor: pointer; font-family: inherit; 
            box-sizing: border-box; margin-bottom: 10px;
        }
        .btn-cancel { background: #ECEFF1; color: #37474F; }
        .btn-confirm { background: var(--primary); color: white; }
        
        .btn-danger-outline {
            background: transparent; border: 2px solid var(--danger); color: var(--danger);
            width: 100%; padding: 16px; border-radius: 16px; font-weight: 700; 
            font-family: inherit; cursor: pointer; font-size: 1.1rem; 
            margin-bottom: 10px; box-sizing: border-box;
        }
        .btn-danger-outline:active { background: var(--danger); color: white; }

        /* Chart */
        .chart-container {
            display: flex; align-items: flex-end; justify-content: space-between;
            height: 150px; margin-top: 20px; padding-bottom: 5px; border-bottom: 2px solid #ECEFF1;
        }
        .chart-col { display: flex; flex-direction: column; align-items: center; width: 12%; }
        .chart-bar-bg {
            width: 100%; height: 120px; background: #FAFAFA; border-radius: 5px;
            display: flex; align-items: flex-end; position: relative;
        }
        .chart-bar { width: 100%; background: var(--primary); border-radius: 5px; min-height: 4px; }
        .chart-label { font-size: 0.7rem; color: #90A4AE; margin-top: 5px; }
        .chart-val { font-size: 0.6rem; position: absolute; top: -15px; width: 100%; text-align: center; color: var(--text); }
        .chart-total-text { font-size: 0.9rem; color: #78909C; margin-top: 10px; }

    </style>
</head>
<body>

    <header>
        <div class="logo">PLANK PANDA</div>
        <div class="header-actions">
            <button class="header-btn" id="btnVoiceToggle" title="Toggle Voice">üîä</button>
            <button class="header-btn" id="btnSettings">‚öôÔ∏è</button>
        </div>
    </header>

    <div class="stage">
        <div class="brain-badge" id="brainBadge">
            <div class="pulsing-dot"></div> AI Brain Active
        </div>
        
        <div class="bubble" id="bubble">Let's hit 1 minute!</div>
        
        <div class="panda-container idle" id="panda">
            <div class="sweat" id="sweat">üí¶</div>
            <div class="leg extra f"></div> <div class="leg extra b"></div>
            <div class="leg arm left"></div> <div class="leg arm right"></div>
            <div class="leg foot left"></div> <div class="leg foot right"></div>
            <div class="body"></div>
            <div class="head">
                <div class="ear left"></div> <div class="ear right"></div>
                <div class="eye left"><div class="pupil"></div></div>
                <div class="eye right"><div class="pupil"></div></div>
                <div class="nose"></div>
            </div>
        </div>
    </div>

    <div class="controls">
        <div class="timer-display" id="timer">00:00</div>
        
        <div class="daily-info">
            <span>Daily Progress</span>
            <span id="dailyTotal">0:00 / 5:00</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>

        <button class="btn-main" id="toggleBtn">START</button>
        <button class="btn-history" id="btnShowHistory">üìä View 7-Day History</button>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="modalSettings">
        <div class="modal">
            <h3>Settings</h3>
            
            <div class="input-group">
                <label>Scenery</label>
                <div class="theme-selector">
                    <div class="theme-btn selected" style="background: #E0F2F1;" data-theme="plain" title="Plain"></div>
                    <div class="theme-btn" style="background: linear-gradient(to bottom, #81D4FA 65%, #81C784 65%);" data-theme="park" title="Park"></div>
                    <div class="theme-btn" style="background: linear-gradient(to bottom, #B0BEC5 65%, #546E7A 65%);" data-theme="street" title="Street"></div>
                    <div class="theme-btn" style="background: linear-gradient(to bottom, #FFCC80 50%, #FFAB91 100%);" data-theme="sunset" title="Sunset"></div>
                </div>
            </div>

            <div class="input-group">
                <label>Daily Goal (Minutes)</label>
                <input type="number" id="inputGoal" value="5" min="1" max="60">
            </div>
            
            <div style="border-top: 1px solid #ECEFF1; margin: 15px 0; padding-top: 15px;">
                <div class="input-group">
                    <label>Gemini API Key (Optional)</label>
                    <input type="password" id="inputApiKey" placeholder="Paste Key Here">
                    <div style="font-size: 0.8rem; color: #90A4AE; margin-top: 5px;">
                        Add key to enable Smart AI & Voice.
                    </div>
                </div>
            </div>
            <button class="btn-modal btn-confirm" id="saveSettings">Save Settings</button>
            <button class="btn-danger-outline" id="btnResetDay">Reset Today's Progress</button>
            <button class="btn-modal btn-cancel" id="closeSettings">Close</button>
        </div>
    </div>

    <!-- History Chart Modal -->
    <div class="modal-overlay" id="modalHistory">
        <div class="modal" style="max-width: 350px;">
            <h3>Past 7 Days</h3>
            <div class="chart-container" id="chartContainer"></div>
            <div class="chart-total-text" id="chartTotalText"></div>
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" id="closeHistory">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- API Config ---
        const apiKey = ""; 

        // --- Theme Definitions ---
        const themes = {
            plain: { 
                bg: '#E0F2F1', 
                bgImage: 'none',
                primary: '#26A69A', primaryDark: '#00897B', text: '#37474F', card: '#FFFFFF', accent: '#FF7043' 
            },
            park: { 
                bg: '#81C784', 
                bgImage: 'linear-gradient(to bottom, #81D4FA 65%, #81C784 65%)', 
                primary: '#66BB6A', primaryDark: '#2E7D32', text: '#1B5E20', card: '#FFFFFF', accent: '#FFA726' 
            },
            street: { 
                bg: '#9E9E9E', 
                bgImage: 'linear-gradient(to bottom, #B0BEC5 65%, #546E7A 65%)',
                primary: '#78909C', primaryDark: '#455A64', text: '#263238', card: '#FFFFFF', accent: '#FF7043' 
            },
            sunset: { 
                bg: '#FFAB91',
                bgImage: 'linear-gradient(to bottom, #FFCC80 0%, #FFAB91 100%)',
                primary: '#FF7043', primaryDark: '#D84315', text: '#3E2723', card: '#FFFFFF', accent: '#FFCA28' 
            }
        };

        // --- State ---
        let state = {
            active: false,
            sessionTime: 0,
            dailyTime: 0,
            goalSeconds: 300,
            interval: null,
            wakeLock: null,
            userApiKey: "",
            useVoice: true,
            theme: 'plain'
        };

        let resetStage = 0;
        let currentSpeechId = 0;
        let audioCtx = null;

        // --- Motivational Database (Fallback) ---
        const phrases = {
            start: ["Let's go! Core tight!", "Assume the position!", "Defy gravity!", "Up you go!"],
            early: ["Check form: straight back!", "Breathe... don't hold it.", "Easy work.", "Solid as a rock."],
            mid: ["Feel that burn!", "Shaking means it's working!", "Stay with me!", "Don't let hips sag!"],
            struggle: ["DON'T YOU DARE DROP!", "HOLD IT!", "MIND OVER MATTER!", "FIGHT THE GRAVITY!", "SCREAM IF YOU HAVE TO!"],
            almost_min: ["ALMOST 1 MINUTE!", "10 SECONDS TO 1 MIN!", "PUSH THROUGH!", "SO CLOSE TO A MINUTE!"],
            milestone: ["üéâ 1 MINUTE! HUGE!", "üéâ 2 MINUTES! BEAST MODE!", "YOU ARE A LEGEND!", "UNSTOPPABLE!"],
            stop: ["Good set. Rest up.", "Nice work.", "My abs... ouch.", "See? You did it."],
            win: ["üéâ DAILY GOAL HIT!", "GOLD MEDAL FOR YOU!", "SEE YOU TOMORROW!"],
            poke: ["Hee hee! That tickles!", "My abs are resting! üò¥", "Ready to start? üí™", "Poke poke! üêº", "I'm soft but strong!", "Hey! No touching!"]
        };

        // --- DOM ---
        const ui = {
            timer: document.getElementById('timer'),
            daily: document.getElementById('dailyTotal'),
            progress: document.getElementById('progress'),
            btn: document.getElementById('toggleBtn'),
            panda: document.getElementById('panda'),
            sweat: document.getElementById('sweat'),
            bubble: document.getElementById('bubble'),
            btnVoiceToggle: document.getElementById('btnVoiceToggle'),
            brainBadge: document.getElementById('brainBadge'),
            modalSettings: document.getElementById('modalSettings'),
            modalHistory: document.getElementById('modalHistory'),
            btnSettings: document.getElementById('btnSettings'),
            saveSettings: document.getElementById('saveSettings'),
            btnResetDay: document.getElementById('btnResetDay'),
            closeSettings: document.getElementById('closeSettings'),
            btnShowHistory: document.getElementById('btnShowHistory'),
            closeHistory: document.getElementById('closeHistory'),
            inputGoal: document.getElementById('inputGoal'),
            inputApiKey: document.getElementById('inputApiKey'),
            chartContainer: document.getElementById('chartContainer'),
            chartTotalText: document.getElementById('chartTotalText'),
            themeBtns: document.querySelectorAll('.theme-btn')
        };

        // --- Theme Logic ---
        function applyTheme(themeName) {
            const t = themes[themeName] || themes.plain;
            const r = document.documentElement.style;
            r.setProperty('--bg', t.bg);
            r.setProperty('--bg-image', t.bgImage);
            r.setProperty('--primary', t.primary);
            r.setProperty('--primary-dark', t.primaryDark);
            r.setProperty('--text', t.text);
            r.setProperty('--card', t.card);
            r.setProperty('--accent', t.accent);
            
            // Update UI selection
            ui.themeBtns.forEach(btn => {
                if(btn.dataset.theme === themeName) btn.classList.add('selected');
                else btn.classList.remove('selected');
            });
            state.theme = themeName;
        }

        // --- Audio Engine ---
        function initAudioEngine() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            const buffer = audioCtx.createBuffer(1, 1, 22050);
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(audioCtx.destination);
            source.start(0);
        }

        function playWavBytes(bytes) {
            if (!audioCtx) initAudioEngine();
            audioCtx.decodeAudioData(bytes.buffer, (buffer) => {
                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                source.connect(audioCtx.destination);
                source.start(0);
            }, (e) => console.error("Error decoding audio", e));
        }

        function pcmToWavBytes(base64PCM, sampleRate = 24000) {
            const binaryString = window.atob(base64PCM);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const wavHeader = createWavHeader(len, sampleRate);
            const wavFile = new Uint8Array(wavHeader.length + len);
            wavFile.set(wavHeader, 0);
            wavFile.set(bytes, wavHeader.length);
            return wavFile;
        }

        function createWavHeader(dataLength, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);
            const buffer = new ArrayBuffer(44);
            const view = new DataView(buffer);
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true); 
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); 
            view.setUint16(20, 1, true); 
            view.setUint16(22, numChannels, true); 
            view.setUint32(24, sampleRate, true); 
            view.setUint32(28, byteRate, true); 
            view.setUint16(32, blockAlign, true); 
            view.setUint16(34, bitsPerSample, true); 
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true); 
            return new Uint8Array(buffer);
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // --- Gemini Service ---
        const Gemini = {
            getEffectiveKey: () => state.userApiKey || apiKey,
            
            async generateMotivation(category, seconds) {
                const key = this.getEffectiveKey();
                if (!key) return null;

                let tone = "Cute and Encouraging";
                if (seconds > 20) tone = "Firm, Focus on Breathing";
                if (seconds > 45) tone = "SCREAMING, INTENSE, URGENT";
                if (category === 'start') tone = "Energetic";
                if (category === 'stop') tone = "Proud";

                const prompt = `You are a talking Panda fitness mascot. 
                Current Plank Time: ${seconds} seconds. 
                Context: ${category}.
                Tone: ${tone}.
                Task: Generate a VERY SHORT (max 7 words) phrase to say to the user.
                Do not use emojis in the text output. Do not use hashtags. Just the spoken words.`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
                } catch (e) {
                    return null;
                }
            },

            async speak(text, speechId, category) {
                const key = this.getEffectiveKey();
                
                const fallbackSpeak = () => {
                    if (speechId !== currentSpeechId || (!state.active && category !== "poke")) return;
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 1.1;
                    utterance.pitch = 1.2; 
                    window.speechSynthesis.speak(utterance);
                };

                if (!state.useVoice) return;
                if (!key) { fallbackSpeak(); return; }

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${key}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: text }] }],
                            generationConfig: {
                                responseModalities: ["AUDIO"],
                                speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } }
                            }
                        })
                    });
                    const data = await response.json();
                    
                    if (speechId !== currentSpeechId || (!state.active && category !== "poke")) return;

                    const audioPart = data.candidates?.[0]?.content?.parts?.[0]?.inlineData;
                    if (!audioPart) { fallbackSpeak(); return; }

                    let sampleRate = 24000;
                    if (audioPart.mimeType) {
                        const match = audioPart.mimeType.match(/rate=(\d+)/);
                        if (match) sampleRate = parseInt(match[1]);
                    }

                    const wavBytes = pcmToWavBytes(audioPart.data, sampleRate);
                    playWavBytes(wavBytes);

                } catch (e) {
                    fallbackSpeak();
                }
            }
        };

        // --- Init ---
        function init() {
            const today = new Date().toISOString().split('T')[0];
            const savedSettings = JSON.parse(localStorage.getItem('pp_settings') || '{}');
            if (savedSettings.goalSeconds) state.goalSeconds = savedSettings.goalSeconds;
            if (savedSettings.userApiKey) state.userApiKey = savedSettings.userApiKey;
            if (savedSettings.useVoice !== undefined) state.useVoice = savedSettings.useVoice;
            if (savedSettings.theme) state.theme = savedSettings.theme;

            ui.inputGoal.value = Math.floor(state.goalSeconds / 60);
            ui.inputApiKey.value = state.userApiKey;
            
            updateVoiceIcon();
            updateBrainBadge();
            applyTheme(state.theme);

            const history = JSON.parse(localStorage.getItem('pp_history') || '{}');
            state.dailyTime = history[today] || 0;
            updateUI();
        }

        function save() {
            const today = new Date().toISOString().split('T')[0];
            const history = JSON.parse(localStorage.getItem('pp_history') || '{}');
            history[today] = state.dailyTime;
            localStorage.setItem('pp_history', JSON.stringify(history));
            
            localStorage.setItem('pp_settings', JSON.stringify({
                goalSeconds: state.goalSeconds,
                userApiKey: state.userApiKey,
                useVoice: state.useVoice,
                theme: state.theme
            }));
        }

        function updateVoiceIcon() {
            if (state.useVoice) {
                ui.btnVoiceToggle.textContent = "üîä";
                ui.btnVoiceToggle.classList.remove('muted');
            } else {
                ui.btnVoiceToggle.textContent = "üîá";
                ui.btnVoiceToggle.classList.add('muted');
            }
        }

        function updateBrainBadge() {
            if (Gemini.getEffectiveKey()) {
                ui.brainBadge.classList.add('visible');
            } else {
                ui.brainBadge.classList.remove('visible');
            }
        }

        // --- Logic ---
        function updateUI() {
            const m = Math.floor(state.sessionTime / 60).toString().padStart(2, '0');
            const s = (state.sessionTime % 60).toString().padStart(2, '0');
            ui.timer.innerText = `${m}:${s}`;

            const goalM = Math.floor(state.goalSeconds / 60);
            const curM = Math.floor(state.dailyTime / 60);
            const curS = (state.dailyTime % 60).toString().padStart(2, '0');
            ui.daily.innerText = `${curM}:${curS} / ${goalM}:00`;

            const pct = Math.min((state.dailyTime / state.goalSeconds) * 100, 100);
            ui.progress.style.width = `${pct}%`;
            ui.progress.style.background = state.dailyTime >= state.goalSeconds ? '#FFD700' : 'var(--primary)';
        }

        async function speak(category) {
            currentSpeechId++;
            const mySpeechId = currentSpeechId;

            let text = "";

            if (Gemini.getEffectiveKey()) {
                ui.bubble.innerText = "...";
                ui.bubble.classList.add('visible');
                
                const aiText = await Gemini.generateMotivation(category, state.sessionTime);
                
                if (mySpeechId !== currentSpeechId || (!state.active && category !== 'poke')) return;

                if (aiText) text = aiText;
            }

            if (!text) {
                let list = phrases[category];
                if (!list && Array.isArray(category)) list = category; 
                if (list) text = list[Math.floor(Math.random() * list.length)];
            }

            if (!text) return;

            ui.bubble.innerText = text;
            ui.bubble.classList.add('visible');
            
            ui.bubble.style.animation = 'none';
            ui.bubble.offsetHeight;
            ui.bubble.style.animation = null; 

            if (state.useVoice) {
                Gemini.speak(text, mySpeechId, category);
            }
        }

        function toggle() {
            if (state.active) stop();
            else start();
        }

        async function start() {
            initAudioEngine();
            
            state.active = true;
            ui.btn.innerText = "STOP";
            ui.btn.classList.add('active');
            ui.panda.classList.remove('idle');
            ui.panda.classList.add('plank');
            
            speak('start');

            if ('wakeLock' in navigator) {
                try { state.wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
            }

            state.interval = setInterval(() => {
                state.sessionTime++;
                state.dailyTime++;
                save();
                updateUI();

                const s = state.sessionTime;

                if (s > 20) ui.panda.classList.add('shaking');
                if (s > 40) ui.sweat.classList.add('active');

                if (s === 10 || s === 20) speak('early');
                if (s === 30) speak('mid');
                if (s === 50) speak('almost_min');
                if (s % 60 === 0) speak('milestone');
                if (s > 60 && s % 15 === 0 && s % 60 !== 0) speak('struggle');

                if (state.dailyTime === state.goalSeconds) speak('win');

            }, 1000);
        }

        function stop() {
            state.active = false;
            
            currentSpeechId++; 
            if (audioCtx) {} 
            window.speechSynthesis.cancel();

            clearInterval(state.interval);
            if (state.wakeLock) state.wakeLock.release();

            ui.btn.innerText = "START";
            ui.btn.classList.remove('active');
            ui.panda.classList.remove('plank', 'shaking');
            ui.sweat.classList.remove('active');
            ui.panda.classList.add('idle');

            if (state.dailyTime >= state.goalSeconds) speak('win');
            else speak('stop');
            
            state.sessionTime = 0;
            setTimeout(updateUI, 500);
        }

        ui.panda.onclick = () => {
            initAudioEngine();
            if (state.active) {
                speak(["Focus!", "Don't touch, just hold!", "No distractions!", "Abs tight!"]);
            } else {
                ui.panda.classList.add('poked');
                speak('poke'); 
                setTimeout(() => ui.panda.classList.remove('poked'), 350);
            }
        };

        ui.btnVoiceToggle.onclick = () => {
            initAudioEngine();
            state.useVoice = !state.useVoice;
            save();
            updateVoiceIcon();
            if (state.useVoice) speak(["Sound Check!", "I can speak!", "Audio On!"]);
        };

        ui.btnSettings.onclick = () => {
            resetStage = 0;
            ui.btnResetDay.innerText = "Reset Today's Progress";
            ui.btnResetDay.style.background = "transparent";
            ui.btnResetDay.style.color = "var(--danger)";
            ui.modalSettings.classList.add('open');
        };
        
        ui.closeSettings.onclick = () => ui.modalSettings.classList.remove('open');
        
        // Theme Selection Event
        ui.themeBtns.forEach(btn => {
            btn.onclick = () => applyTheme(btn.dataset.theme);
        });

        ui.saveSettings.onclick = () => {
            initAudioEngine();
            const val = parseInt(ui.inputGoal.value);
            if (val && val > 0) state.goalSeconds = val * 60;
            
            state.userApiKey = ui.inputApiKey.value.trim();

            save();
            updateUI();
            updateBrainBadge();
            ui.modalSettings.classList.remove('open');
            speak("poke"); 
        };

        ui.btnResetDay.onclick = () => {
            if (resetStage === 0) {
                ui.btnResetDay.innerText = "Are you sure? Tap again.";
                ui.btnResetDay.style.background = "var(--danger)";
                ui.btnResetDay.style.color = "white";
                resetStage = 1;
            } else {
                state.dailyTime = 0;
                save();
                updateUI();
                ui.modalSettings.classList.remove('open');
                speak('early'); 
                resetStage = 0;
            }
        };

        ui.btnShowHistory.onclick = () => {
            const history = JSON.parse(localStorage.getItem('pp_history') || '{}');
            const today = new Date();
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            let html = '';
            let totalWeek = 0;

            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(today.getDate() - i);
                const key = d.toISOString().split('T')[0];
                const val = history[key] || 0;
                const label = days[d.getDay()];
                totalWeek += val;
                
                const pct = Math.min((val / state.goalSeconds) * 100, 100);
                const displayHeight = pct === 0 ? 5 : pct;
                const color = val >= state.goalSeconds ? '#FFD700' : 'var(--primary)';

                html += `
                <div class="chart-col">
                    <div class="chart-bar-bg">
                        ${val > 0 ? `<div class="chart-val">${Math.floor(val/60)}m</div>` : ''}
                        <div class="chart-bar" style="height: ${displayHeight}%; background: ${color}"></div>
                    </div>
                    <div class="chart-label">${label}</div>
                </div>`;
            }

            ui.chartContainer.innerHTML = html;
            ui.chartTotalText.innerText = `Total this week: ${Math.floor(totalWeek/60)} mins`;
            ui.modalHistory.classList.add('open');
        };
        ui.closeHistory.onclick = () => ui.modalHistory.classList.remove('open');

        ui.btn.onclick = toggle;
        init();

    </script>
</body>
</html>
